<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Инициализация элементов ---
            const mapContainer = document.getElementById('map');
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menuToggle'); // Кнопка меню
            const addPointBtn = document.getElementById('addPointBtn'); // Главная кнопка
            const cancelAddModeBtn = document.getElementById('cancelAddMode'); // Отмена добавления
            const overlay = document.getElementById('overlay');
            const cancelBtn = document.getElementById('cancelBtn'); // Отмена формы
            const saveBtn = document.getElementById('saveBtn'); // Сохранение формы
            const reportsList = document.getElementById('reportsList'); // Список отчетов
            const exportBtn = document.getElementById('exportBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            // Проверка наличия Leaflet (критически важно для работы карты)
            if (typeof L === 'undefined') {
                console.error('Leaflet library failed to load.');
                alert('Ошибка: Библиотека карты (Leaflet) не загружена. Проверьте соединение.');
                return; 
            }
            
            // Создание кастомных иконок с помощью Leaflet.DivIcon
            const createCustomIcon = (className, content) => new L.DivIcon({
                className: className,
                html: content,
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
            const iconOpen = createCustomIcon('marker-icon-open', '<i class="fa fa-trash"></i>');
            const iconCleaned = createCustomIcon('marker-icon-clean', '<i class="fa fa-check"></i>');

            
            // --- Инициализация карты и логика ---
            const map = L.map('map').setView([43.25, 76.95], 12); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            const STORAGE_KEY = 'ecomap_reports_v2';
            let reports = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const markers = L.layerGroup().addTo(map);

            function escapeHtml(s='') { return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

            // ... (Функция renderReports остается без изменений) ...
            function renderReports() {
                markers.clearLayers();
                const list = reportsList; // Используем переменную
                list.innerHTML = '';
                
                reports.forEach((r, i) => {
                    const el = document.createElement('div');
                    el.className = 'report';
                    el.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>${escapeHtml(r.title || 'Без названия')}</strong>
                            <span class="${r.cleaned ? 'status-clean' : 'status-open'}">${r.cleaned ? 'Убрано' : 'Открыто'}</span>
                        </div>
                        <div class="meta">${new Date(r.created).toLocaleDateString()} ${new Date(r.created).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} • ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
                        <div>${escapeHtml(r.description || 'Нет описания')}</div>
                    `;
                    if (r.photo) {
                        const img = document.createElement('img');
                        img.src = r.photo;
                        img.className = 'thumb';
                        el.appendChild(img);
                    }

                    const actions = document.createElement('div');
                    actions.style.marginTop = '10px';
                    actions.style.display = 'flex';
                    actions.style.gap = '8px';
                    actions.innerHTML = `
                        <button class="small" data-idx="${i}" data-action="goto">Перейти</button>
                        <button class="small btn-ghost" data-idx="${i}" data-action="toggle">${r.cleaned ? 'Отменить Уборку' : 'Отметить как Убрано'}</button>
                        <button class="small btn-ghost" data-idx="${i}" data-action="delete" style="color:var(--danger-color);border-color:#f8d7da;">Удалить</button>
                    `;
                    el.appendChild(actions);
                    list.appendChild(el);

                    const markerIcon = r.cleaned ? iconCleaned : iconOpen;
                    const marker = L.marker([r.lat, r.lng], { icon: markerIcon }).addTo(markers);
                    let popupHtml = `<strong style="font-size:1.1em;">${escapeHtml(r.title || 'Без названия')}</strong><br>`;
                    popupHtml += `<span style="font-size:0.9em;color:var(--secondary-color);">${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</span><hr style="margin:5px 0;">`;
                    popupHtml += `<p>${escapeHtml(r.description || 'Нет описания')}</p>`;
                    if (r.photo) popupHtml += `<img src="${r.photo}" style="width:100%;max-width:250px;height:auto;margin-top:6px;border-radius:6px;object-fit:cover;">`;
                    marker.bindPopup(popupHtml);
                });
            }
            renderReports();

            // --- Логика добавления точки ---
            let addingMode = false;
            const addModeMessage = document.getElementById('addModeMessage');
            
            // ... (toggleAddingMode и map.on('click') остаются без изменений) ...
            function toggleAddingMode(enable) {
                addingMode = enable;
                mapContainer.classList.toggle('map-adding-mode', enable); // Используем mapContainer
                addModeMessage.style.display = enable ? 'block' : 'none';
            }
            map.on('click', (e) => {
                if (addingMode) {
                    openFormAt(e.latlng);
                    toggleAddingMode(false);
                }
            });


            // --- НАЗНАЧЕНИЕ ОБРАБОТЧИКОВ (Используем addEventListener) ---
            
            // 1. Кнопка меню (Мобильная)
            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            // 2. Главная кнопка "Сообщить"
            addPointBtn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAddingMode(true);
            });
            
            // 3. Отмена режима добавления
            cancelAddModeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAddingMode(false);
            });

            // --- Модальное окно и форма (Остается без изменений, но используется addEventListener) ---
            const coordsInput = document.getElementById('coords');
            const titleInput = document.getElementById('titleInput');
            const descInput = document.getElementById('descInput');
            const photoInput = document.getElementById('photoInput');
            const photoPreview = document.getElementById('photoPreview');
            let currentLatLng = null;
            let currentPhotoData = null;

            function openFormAt(latlng) {
                currentLatLng = latlng;
                coordsInput.value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                titleInput.value = '';
                descInput.value = '';
                photoInput.value = ''; 
                photoPreview.style.display = 'none';
                photoPreview.src = '';
                currentPhotoData = null;
                overlay.style.display = 'flex';
                titleInput.focus(); 
            }
            cancelBtn.addEventListener('click', () => overlay.style.display = 'none');

            // ... (PhotoInput, persist, saveBtn, reportsList.addEventListener - остаются без изменений) ...

            photoInput.addEventListener('change', (ev) => {
                const file = ev.target.files?.[0];
                if (!file) {
                    photoPreview.style.display = 'none';
                    currentPhotoData = null;
                    return;
                }
                if (file.size > 2 * 1024 * 1024) { 
                    alert('Размер файла превышает 2MB. Пожалуйста, выберите меньший файл.');
                    photoInput.value = '';
                    photoPreview.style.display = 'none';
                    currentPhotoData = null;
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                    photoPreview.src = reader.result;
                    photoPreview.style.display = 'block';
                    currentPhotoData = reader.result; 
                };
                reader.readAsDataURL(file);
            });

            saveBtn.addEventListener('click', () => {
                const t = titleInput.value.trim();
                if (!t) {
                    alert('Пожалуйста, укажите заголовок!');
                    titleInput.focus();
                    return;
                }

                const d = descInput.value.trim();
                const item = {
                    id: Date.now(),
                    title: t,
                    description: d,
                    lat: currentLatLng.lat,
                    lng: currentLatLng.lng,
                    photo: currentPhotoData || null,
                    cleaned: false,
                    created: Date.now()
                };
                reports.unshift(item); 
                persist();
                renderReports();
                overlay.style.display = 'none';
            });

            function persist() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
            }

            // list actions (delegation)
            reportsList.addEventListener('click', (ev) => {
                const btn = ev.target.closest('button');
                if (!btn) return;
                const idx = Number(btn.dataset.idx);
                const action = btn.dataset.action;
                const r = reports[idx];
                if (!r) return;

                if (action === 'goto') {
                    map.setView([r.lat, r.lng], 16); 
                    if (window.innerWidth <= 768) { 
                        sidebar.classList.remove('active');
                    }
                } else if (action === 'toggle') {
                    reports[idx].cleaned = !reports[idx].cleaned;
                    persist();
                    renderReports();
                } else if (action === 'delete') {
                    if (!confirm(`Вы действительно хотите удалить отчёт "${r.title}"?`)) return;
                    reports.splice(idx,1);
                    persist();
                    renderReports();
                }
            });

            // Export / Clear
            exportBtn.addEventListener('click', () => {
                if (reports.length === 0) {
                    alert('Нет данных для экспорта.');
                    return;
                }
                const data = JSON.stringify(reports, null, 2);
                const blob = new Blob([data], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'ecomap_reports.json'; a.click();
                URL.revokeObjectURL(url);
            });
            clearBtn.addEventListener('click', () => {
                if (!confirm('Вы уверены? Это удалит ВСЕ сохранённые отчёты!')) return;
                reports = [];
                persist();
                renderReports();
            });

            // Добавление прослушивателей после renderReports
            renderReports();
        });
    </script>
    </script>
</body>

</html>
