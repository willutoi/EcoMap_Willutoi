<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMap — Отчёты о загрязнениях</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --gray: #6c757d;
            --light: #f8f9fa;
            --dark: #343a40;
            --bg: #f7f9fc;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background:var(--bg); color:#333; overflow:hidden; height:100vh; }
        #map { position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; }

        .sidebar {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 400px; max-width: 95vw;
            background: white;
            box-shadow: -8px 0 30px rgba(0,0,0,0.15);
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
        }

        h1 { font-size: 26px; color: var(--primary); margin-bottom: 8px; display:flex; align-items:center; gap:10px; }
        .meta { font-size: 14px; color: var(--gray); margin-bottom: 20px; }

        .btn {
            padding: 11px 18px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid #cfe2ff;
        }
        .btn-secondary:hover { background: #e7f0ff; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c82333; }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }

        .report {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s;
        }
        .report:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }

        .report h3 { margin: 0 0 6px; font-size: 17px; color: #222; }
        .report .meta { font-size: 13px; color: var(--gray); margin: 6px 0; }
        .report img { width:100%; max-height:180px; object-fit:cover; border-radius:8px; margin-top:10px; border:1px solid #eee; }
        .report .actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }

        .status { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .open { background: #ffebee; color: var(--danger); }
        .cleaned { background: #e8f5e9; color: var(--success); }

        #menuToggle {
            position: fixed;
            top: 15px; right: 15px;
            z-index: 1001;
            background: rgba(0,123,255,0.9);
            color: white;
            border: none;
            width: 50px; height: 50px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        @media (max-width: 768px) { #menuToggle { display: block; } }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            padding: 20px;
        }
        .modal {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 480px;
            padding: 24px;
            box-shadow: var(--shadow);
            position: relative;
        }
        .modal h3 { margin-bottom: 16px; color: var(--primary); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display:block; margin-bottom:6px; font-weight:600; color:#333; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }
        .form-group input:disabled { background:#f8f9fa; }

        #addModeHint {
            position: fixed;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 999;
            display: none;
            box-shadow: var(--shadow);
        }

        .loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .marker-icon-open i { color: #d32f2f; font-size: 28px; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .marker-icon-clean i { color: #4caf50; font-size: 28px; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="map"></div>

    <button id="menuToggle"><i class="fas fa-bars"></i></button>

    <div id="addModeHint">
        Кликните по карте для добавления <a href="#" id="cancelAdd" style="color:#ffeb3b;margin-left:10px;">Отмена</a>
    </div>

    <div class="sidebar" id="sidebar">
        <h1>EcoMap <i class="fas fa-leaf" style="color:var(--success);"></i></h1>
        <p class="meta">Отчёты о местах загрязнений от жителей</p>

        <div class="btn-group">
            <button class="btn btn-primary" id="addBtn"><i class="fas fa-plus"></i> Добавить точку</button>
            <button class="btn btn-secondary" id="exportBtn" disabled>Export JSON</button>
            <button class="btn btn-secondary" id="clearBtn" disabled>Clear All</button>
        </div>

        <div id="confirmBox" style="display:none;background:#fff3cd;padding:15px;border-radius:10px;margin:15px 0;border:1px solid #ffeaa7;">
            <strong>Удалить все отчёты навсегда?</strong><br><br>
            <button class="btn btn-danger" id="confirmYes">Да</button>
            <button class="btn btn-secondary" id="confirmNo">Нет</button>
        </div>

        <div id="list"></div>

        <div style="margin-top:40px;padding-top:20px;border-top:1px solid #eee;">
            <h3><i class="fas fa-globe"></i> Миссия</h3>
            <p style="font-size:14px;line-height:1.6;margin-top:10px;">
                Помогаем делать мир чище. Отмечайте проблемы — волонтёры убирают!
            </p>
            <p class="meta" style="margin-top:15px;font-size:13px;">
                Технологии: Leaflet, Firebase, Responsive UI
            </p>
        </div>
    </div>

    <div class="overlay" id="overlay">
        <div class="modal">
            <div class="loading" id="modalLoading"><div class="spinner"></div></div>
            <h3>Новый отчёт</h3>
            <div id="error" style="color:var(--danger);margin-bottom:10px;font-weight:600;"></div>

            <div class="form-group">
                <label>Координаты</label>
                <input type="text" id="coords" disabled>
            </div>
            <div class="form-group">
                <label>Заголовок *</label>
                <input type="text" id="title" placeholder="Свалка мусора у реки">
            </div>
            <div class="form-group">
                <label>Описание</label>
                <textarea id="desc" rows="4" placeholder="Подробности: тип мусора, размер зоны..."></textarea>
            </div>
            <div class="form-group">
                <label>Фото (max 3MB)</label>
                <input type="file" id="photo" accept="image/*">
                <img id="preview" style="display:none;width:100%;margin-top:10px;border-radius:8px;max-height:200px;object-fit:cover;">
            </div>

            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button class="btn btn-secondary" id="cancel">Отмена</button>
                <button class="btn btn-primary" id="save">Сохранить</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

        const app = initializeApp({
            apiKey: "AIzaSyBchhpXlXNukYDgQHlRD0qPfQjvf8hsS8",
            authDomain: "ecomap-22dc4.firebaseapp.com",
            projectId: "ecomap-22dc4",
            storageBucket: "ecomap-22dc4.appspot.com",
            messagingSenderId: "88803528674",
            appId: "1:88803528674:web:d33c8ddacccf2286be33bb"
        });

        const db = getFirestore(app);
        const storage = getStorage(app);
        const col = collection(db, "reports");

        // Main app code starts here (now inside the module)
        const map = L.map('map').setView([43.25, 76.95], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        const markers = L.layerGroup().addTo(map);
        const openIcon = L.divIcon({className: "marker-icon-open", html: '<i class="fas fa-trash-alt"></i>', iconSize: [30,30], iconAnchor: [15,30]});
        const cleanIcon = L.divIcon({className: "marker-icon-clean", html: '<i class="fas fa-check-circle"></i>', iconSize: [30,30], iconAnchor: [15,30]});

        const sidebar = document.getElementById('sidebar');
        const list = document.getElementById('list');
        const overlay = document.getElementById('overlay');
        const modalLoading = document.getElementById('modalLoading');
        const addBtn = document.getElementById('addBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const confirmBox = document.getElementById('confirmBox');

        let adding = false;
        let reports = [];

        // Подписка на данные
        onSnapshot(query(col, orderBy("created", "desc")), snap => {
            reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
            render();
        }, err => {
            console.error('Firestore error:', err);
            list.innerHTML = `<div style="color:var(--danger);padding:15px;background:#ffebee;border-radius:8px;">Ошибка загрузки: ${err.message}. Проверьте правила Firebase.</div>`;
        });

        function render() {
            markers.clearLayers();
            list.innerHTML = reports.length === 0
                ? '<p style="text-align:center;color:#888;margin:30px 0;">Нет отчётов</p>'
                : '';

            exportBtn.disabled = clearBtn.disabled = reports.length === 0;

            reports.forEach(r => {
                const date = r.created ? new Date(r.created.seconds * 1000) : new Date();
                const div = document.createElement('div');
                div.className = 'report';
                div.innerHTML = `
                    <h3>${escape(r.title || 'Без названия')}</h3>
                    <div class="meta">
                        ${date.toLocaleString('ru')} • ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}
                        <span class="status ${r.cleaned ? 'cleaned' : 'open'}">${r.cleaned ? 'Убрано' : 'Открыто'}</span>
                    </div>
                    ${r.description ? `<p>${escape(r.description)}</p>` : ''}
                    ${r.photo ? `<img src="${r.photo}" alt="Фото" loading="lazy">` : ''}
                    <div class="actions">
                        <button class="btn btn-secondary" data-id="${r.id}" data-act="go">На карту</button>
                        <button class="btn ${r.cleaned ? 'btn-secondary' : 'btn-success'} " data-id="${r.id}" data-act="toggle">
                            ${r.cleaned ? 'Отменить' : 'Убрано'}
                        </button>
                        <button class="btn btn-secondary" style="color:var(--danger);border-color:var(--danger);" data-id="${r.id}" data-act="del">Удалить</button>
                    </div>
                `;
                list.appendChild(div);

                const marker = L.marker([r.lat, r.lng], {icon: r.cleaned ? cleanIcon : openIcon}).addTo(markers);
                marker.bindPopup(`<b>${escape(r.title)}</b><p>${escape(r.description || '')}</p>${r.photo ? `<img src="${r.photo}" style="width:100%;border-radius:6px;margin-top:5px;">` : ''}`, {maxWidth: 300});
            });
        }

        function escape(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

        // Добавление точки
        addBtn.onclick = () => {
            adding = true;
            document.getElementById('addModeHint').style.display = 'block';
            map.getContainer().style.cursor = 'crosshair';
            if (window.innerWidth <= 768) sidebar.classList.remove('active');
        };
        document.getElementById('cancelAdd').onclick = e => { e.preventDefault(); resetAdding(); };

        function resetAdding() {
            adding = false;
            document.getElementById('addModeHint').style.display = 'none';
            map.getContainer().style.cursor = '';
        }

        map.on('click', e => {
            if (!adding) return;
            resetAdding();

            document.getElementById('coords').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            document.getElementById('title').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('photo').value = '';
            document.getElementById('preview').style.display = 'none';
            document.getElementById('error').textContent = '';
            overlay.style.display = 'flex';
            window.currentPos = e.latlng;
            window.currentPhoto = null;
        });

        document.getElementById('cancel').onclick = () => overlay.style.display = 'none';
        overlay.onclick = e => { if (e.target === overlay) overlay.style.display = 'none'; };

        document.getElementById('photo').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 3*1024*1024) {
                document.getElementById('error').textContent = 'Фото слишком большое (макс. 3MB)';
                return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                document.getElementById('preview').src = reader.result;
                document.getElementById('preview').style.display = 'block';
                window.currentPhoto = reader.result;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('save').onclick = async () => {
            const title = document.getElementById('title').value.trim();
            if (!title) {
                document.getElementById('error').textContent = 'Заголовок обязателен!';
                return;
            }

            const saveBtn = document.getElementById('save');
            saveBtn.disabled = true;
            modalLoading.style.display = 'flex';

            try {
                let photoURL = null;
                if (window.currentPhoto) {
                    const storageRef = ref(storage, `photos/${Date.now()}.jpg`);
                    await uploadString(storageRef, window.currentPhoto, 'data_url');
                    photoURL = await getDownloadURL(storageRef);
                }

                await addDoc(col, {
                    title,
                    description: document.getElementById('desc').value.trim(),
                    lat: window.currentPos.lat,
                    lng: window.currentPos.lng,
                    photo: photoURL,
                    cleaned: false,
                    created: serverTimestamp()
                });
                overlay.style.display = 'none';
            } catch (err) {
                document.getElementById('error').textContent = `Ошибка: ${err.message}. Проверьте правила Firebase (allow read/write) и консоль.`;
                console.error(err);
            } finally {
                saveBtn.disabled = false;
                modalLoading.style.display = 'none';
            }
        };

        // Действия в отчётах
        list.onclick = async e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            const act = btn.dataset.act;
            const r = reports.find(x => x.id === id);

            btn.disabled = true;
            try {
                if (act === 'go') {
                    map.setView([r.lat, r.lng], 17);
                } else if (act === 'toggle') {
                    await updateDoc(doc(db, 'reports', id), {cleaned: !r.cleaned});
                } else if (act === 'del') {
                    if (confirm('Удалить этот отчёт?')) {
                        await deleteDoc(doc(db, 'reports', id));
                    }
                }
            } catch (err) {
                alert(`Ошибка: ${err.message}`);
            } finally {
                btn.disabled = false;
            }
        };

        // Export
        exportBtn.onclick = () => {
            const data = reports.map(r => ({
                ...r,
                created: r.created ? new Date(r.created.seconds * 1000).toISOString() : null
            }));
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ecomap_reports_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Clear All
        clearBtn.onclick = () => confirmBox.style.display = 'block';
        document.getElementById('confirmNo').onclick = () => confirmBox.style.display = 'none';
        document.getElementById('confirmYes').onclick = async () => {
            confirmBox.style.display = 'none';
            const confirmYes = document.getElementById('confirmYes');
            confirmYes.disabled = true;
            try {
                const snap = await getDocs(col);
                if (snap.empty) return;
                const batch = writeBatch(db);
                snap.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            } catch (err) {
                alert(`Ошибка очистки: ${err.message}`);
            } finally {
                confirmYes.disabled = false;
            }
        };

        document.getElementById('menuToggle').onclick = () => sidebar.classList.toggle('active');

        setTimeout(() => map.invalidateSize(), 100);
    </script>
</body>
</html>
