<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoMap — Карта загрязнений</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary: #00d4ff;
            --primary-dark: #00a8cc;
            --success: #28a745;
            --danger: #e74c3c;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --glass: rgba(255, 255, 255, 0.15);
            --text: #333;
            --radius: 24px;
            --shadow: 0 20px 60px rgba(0,0,0,0.25);
        }
        * {margin:0;padding:0;box-sizing:border-box;}
        body {
            font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            height:100vh; overflow:hidden; background:var(--bg); color:var(--text);
            background-attachment:fixed;
        }
        #map {position:fixed; inset:0; z-index:1;}

        .sidebar {
            position:fixed; top:0; right:0; height:100%; width:400px; max-width:95vw;
            background: var(--glass); backdrop-filter: blur(20px); border-left:1px solid rgba(255,255,255,0.2);
            padding:24px; overflow-y:auto; z-index:100; transition:transform .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform:translateX(0);
        }
        @media (max-width:768px) {
            .sidebar {transform:translateX(110%); box-shadow:none;}
            .sidebar.active {transform:translateX(0);}
        }

        h1 {
            font-size:28px; font-weight:800; background:linear-gradient(90deg, #00d4ff, #764ba2); -webkit-background-clip:text;
            -webkit-text-fill-color:transparent; margin-bottom:8px; display:flex; align-items:center; gap:12px;
        }

        .btn {
            padding:14px 24px; border:none; border-radius:16px; font-weight:700; cursor:pointer;
            transition:all .3s ease; box-shadow:0 8px 25px rgba(0,212,255,0.3);
        }
        .btn-primary {
            background:linear-gradient(45deg, var(--primary), var(--primary-dark)); color:white;
        }
        .btn-primary:hover {transform:translateY(-4px); box-shadow:0 15px 35px rgba(0,212,255,0.4);}
        .btn-ghost {
            background:rgba(255,255,255,0.2); color:white; border:2px solid rgba(255,255,255,0.3); backdrop-filter:blur(10px);
        }
        .btn-ghost:hover {background:rgba(255,255,255,0.3); transform:translateY(-2px);}

        /* ИДЕАЛЬНАЯ СИММЕТРИЯ МОДАЛКИ */
        .overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(10px);
            display:none; align-items:center; justify-content:center; z-index:1002;
            padding:20px; animation:fadeIn .4s ease;
        }
        @keyframes fadeIn {from{opacity:0}to{opacity:1}}
        .card {
            background:var(--card-bg); padding:40px; border-radius:var(--radius);
            width:100%; max-width:560px; box-shadow:var(--shadow); position:relative;
            backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.3);
            animation:popUp .5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp {
            0% {transform:scale(0.8); opacity:0;}
            100% {transform:scale(1); opacity:1;}
        }

        .row {margin-bottom:24px;}
        .row label {display:block; margin-bottom:10px; font-weight:700; font-size:16px; color:#222;}
        .row input, .row textarea {
            width:100%; padding:16px; border:none; border-radius:16px; background:rgba(255,255,255,0.7);
            font-size:16px; backdrop-filter:blur(10px); transition:all .3s;
        }
        .row input:focus, .row textarea:focus {outline:none; background:white; box-shadow:0 0 0 4px rgba(0,212,255,0.2);}

        .thumb {
            width:100%; max-height:240px; object-fit:cover; border-radius:16px; margin-top:16px;
            box-shadow:0 10px 30px rgba(0,0,0,0.2);
        }

        .loading {
            position:absolute; inset:0; background:rgba(255,255,255,0.98); border-radius:var(--radius);
            display:none; align-items:center; justify-content:center; z-index:10;
        }
        .spinner {
            width:56px; height:56px; border:6px solid #f0f0f0; border-top:6px solid var(--primary);
            border-radius:50%; animation:spin 1s linear infinite;
        }

        #menuToggle {
            position:fixed; top:20px; right:20px; z-index:1001;
            background:linear-gradient(45deg, var(--primary), var(--primary-dark));
            color:white; border:none; width:60px; height:60px; border-radius:50%;
            font-size:26px; box-shadow:0 10px 30px rgba(0,212,255,0.4); display:none;
            animation:pulse 2s infinite;
        }
        @keyframes pulse {0%,100%{box-shadow:0 10px 30px rgba(0,212,255,0.4)} 50%{box-shadow:0 10px 50px rgba(0,212,255,0.6)}}
        @media (max-width:768px) {#menuToggle{display:block;}}
    </style>
</head>
<body>
    <div id="map"></div>

    <button id="menuToggle"><i class="fas fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <h1>EcoMap</h1>
        <p style="color:rgba(255,255,255,0.9);font-size:15px;margin-bottom:24px;">Карта экологических проблем от жителей</p>

        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
            <button id="addPointBtn" class="btn btn-primary">Добавить точку</button>
            <button id="exportBtn" class="btn btn-ghost" disabled>Export</button>
            <button id="clearBtn" class="btn btn-ghost" disabled>Очистить</button>
        </div>

        <div id="confirmBox" style="display:none;background:rgba(231,76,60,0.2);padding:20px;border-radius:16px;border:1px solid rgba(231,76,60,0.4);margin-bottom:20px;">
            <strong style="color:white;">Удалить все отчёты?</strong><br><br>
            <button id="confirmYes" style="background:#e74c3c;padding:12px 24px;border-radius:16px;color:white;border:none;font-weight:700;">Да, удалить</button>
            <button id="confirmNo" class="btn btn-ghost" style="margin-left:12px;">Отмена</button>
        </div>

        <div id="list"></div>
    </div>

    <div class="overlay" id="overlay">
        <div class="card">
            <div class="loading" id="loading"><div class="spinner"></div></div>
            <h3 style="font-size:24px;font-weight:800;margin-bottom:28px;background:linear-gradient(90deg,#00d4ff,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
                Новая точка на карте
            </h3>
            <div id="error" style="color:#e74c3c;margin-bottom:20px;font-weight:600;"></div>

            <div class="row"><label>Координаты</label><input type="text" id="coords" disabled style="background:rgba(0,212,255,0.1);"></div>
            <div class="row"><label>Заголовок *</label><input id="title" placeholder="Например: Мусор у реки"></div>
            <div class="row"><label>Описание</label><textarea id="desc" rows="4" placeholder="Расскажите подробнее..."></textarea></div>
            <div class="row"><label>Фото (до 2 МБ)</label><input id="photo" type="file" accept="image/*"><img id="preview" class="thumb" style="display:none;"></div>

            <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:32px;">
                <button id="cancel" class="btn btn-ghost">Отмена</button>
                <button id="save" class="btn btn-primary">Сохранить</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

        const app = initializeApp({
            apiKey: "AIzaSyBchhpXlXNukYDgQHlRD0qPfQjvf8hsS8",
            authDomain: "ecomap-22dc4.firebaseapp.com",
            projectId: "ecomap-22dc4",
            storageBucket: "ecomap-22dc4.appspot.com",
            messagingSenderId: "88803528674",
            appId: "1:88803528674:web:d33c8ddacccf2286be33bb"
        });

        const db = getFirestore(app);
        const storage = getStorage(app);
        const col = collection(db, "reports");

        const map = L.map('map').setView([43.25, 76.95], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: ''}).addTo(map);
        const markers = L.layerGroup().addTo(map);
        setTimeout(() => map.invalidateSize(), 300);

        const openIcon = L.divIcon({html:'<i class="fa-solid fa-dumpster-fire" style="color:#e74c3c;font-size:32px;"></i>', iconSize:[40,40], iconAnchor:[20,40]});
        const cleanIcon = L.divIcon({html:'<i class="fa-solid fa-seedling" style="color:#27ae60;font-size:32px;"></i>', iconSize:[40,40], iconAnchor:[20,40]});

        const sidebar = document.getElementById('sidebar');
        const list = document.getElementById('list');
        const overlay = document.getElementById('overlay');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        let adding = false;
        let reports = [];

        onSnapshot(query(col, orderBy('created','desc')), snap => {
            reports = snap.docs.map(d => ({id:d.id, ...d.data()}));
            render();
        });

        function render() {
            markers.clearLayers(); list.innerHTML = reports.length ? '' : '<p style="text-align:center;color:rgba(255,255,255,0.7);margin:60px 0;font-size:18px;">Пока нет отчётов<br>Будьте первым!</p>';
            document.getElementById('exportBtn').disabled = document.getElementById('clearBtn').disabled = !reports.length;

            reports.forEach(r => {
                const date = r.created ? new Date(r.created.seconds*1000) : new Date();
                const div = document.createElement('div');
                div.style = 'background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);padding:20px;border-radius:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.2);';
                div.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <strong style="font-size:18px;color:white;">${r.title||'Без названия'}</strong>
                        <span style="padding:6px 14px;border-radius:30px;font-size:13px;font-weight:700;background:${r.cleaned?'rgba(39,174,96,0.3)':'rgba(231,76,60,0.3)'};color:white;border:1px solid ${r.cleaned?'#27ae60':'#e74c3c'};">${r.cleaned?'Убрано':'Открыто'}</span>
                    </div>
                    <div style="color:rgba(255,255,255,0.8);font-size:14px;margin-bottom:12px;">${date.toLocaleString('ru').slice(0,-3)} • ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
                    ${r.description ? `<p style="color:rgba(255,255,255,0.9);margin-bottom:12px;">${r.description}</p>` : ''}
                    ${r.photo ? `<img src="${r.photo}" style="width:100%;border-radius:16px;margin-bottom:12px;">` : ''}
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn-ghost" style="padding:10px 16px;font-size:14px;" data-id="${r.id}" data-act="go">На карте</button>
                        <button class="btn-ghost" style="padding:10px 16px;font-size:14px;" data-id="${r.id}" data-act="toggle">${r.cleaned?'Отменить':'Убрано'}</button>
                        <button class="btn-ghost" style="padding:10px 16px;font-size:14px;color:#e74c3c;" data-id="${r.id}" data-act="del">Удалить</button>
                    </div>
                `;
                list.appendChild(div);

                L.marker([r.lat, r.lng], {icon: r.cleaned?cleanIcon:openIcon}).addTo(markers)
                 .bindPopup(`<div style="padding:8px;"><b style="font-size:16px;">${r.title||'Без названия'}</b><br><small>${r.description||''}</small>${r.photo?`<img src="${r.photo}" style="width:100%;margin-top:8px;border-radius:12px;">`:''}</div>`, {maxWidth:300});
            });
        }

        document.getElementById('addPointBtn').onclick = () => {
            adding = true;
            map.getContainer().style.cursor = 'crosshair';
        };

        map.on('click', e => {
            if (!adding) return;
            adding = false;
            map.getContainer().style.cursor = '';

            document.getElementById('coords').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            document.getElementById('title').value = document.getElementById('desc').value = '';
            document.getElementById('photo').value = ''; document.getElementById('preview').style.display = 'none';
            errorDiv.textContent = '';
            overlay.style.display = 'flex';
            window.pos = e.latlng;
            window.photoData = null;
        });

        document.getElementById('cancel').onclick = () => overlay.style.display = 'none';
        overlay.onclick = e => {if(e.target===overlay) overlay.style.display='none';};

        document.getElementById('photo').onchange = e => {
            const f = e.target.files[0];
            if (!f) return;
            if (f.size > 2*1024*1024) { errorDiv.textContent = 'Фото больше 2 МБ'; return; }
            const r = new FileReader();
            r.onload = () => { document.getElementById('preview').src = r.result; document.getElementById('preview').style.display = 'block'; window.photoData = r.result; };
            r.readAsDataURL(f);
        };

        document.getElementById('save').onclick = async () => {
            const title = document.getElementById('title').value.trim();
            if (!title) return errorDiv.textContent = 'Введите заголовок!';

            const saveBtn = document.getElementById('save');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            loading.style.display = 'flex';

            try {
                let url = null;
                if (window.photoData) {
                    const sref = ref(storage, `photos/${Date.now()}.jpg`);
                    await uploadString(sref, window.photoData, 'data_url');
                    url = await getDownloadURL(sref);
                }
                await addDoc(col, {
                    title,
                    description: document.getElementById('desc').value.trim(),
                    lat: window.pos.lat,
                    lng: window.pos.lng,
                    photo: url,
                    cleaned: false,
                    created: serverTimestamp()
                });
                overlay.style.display = 'none';
            } catch (err) {
                errorDiv.textContent = 'Ошибка: ' + err.message;
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить Отчёт';
                loading.style.display = 'none';
            }
        };

        list.onclick = async e => {
            const b = e.target.closest('button');
            if (!b) return;
            b.disabled = true;
            const id = b.dataset.id;
            try {
                if (b.dataset.act === 'go') map.setView([reports.find(r=>r.id===id).lat, reports.find(r=>r.id===id).lng], 17);
                if (b.dataset.act === 'toggle') await updateDoc(doc(db,'reports',id),{cleaned:!reports.find(r=>r.id===id).cleaned});
                if (b.dataset.act === 'del' && confirm('Удалить отчёт?')) await deleteDoc(doc(db,'reports',id));
            } catch(err) {alert(err.message);}
            b.disabled = false;
        };

        document.getElementById('exportBtn').onclick = () => {
            const data = reports.map(r=>({...r, created:r.created?.toDate?.().toISOString()||null}));
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
            a.download = `ecomap_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        document.getElementById('clearBtn').onclick = () => document.getElementById('confirmBox').style.display = 'block';
        document.getElementById('confirmNo').onclick = () => document.getElementById('confirmBox').style.display = 'none';
        document.getElementById('confirmYes').onclick = async () => {
            document.getElementById('confirmBox').style.display = 'none';
            document.getElementById('confirmYes').disabled = true;
            try {
                const snap = await getDocs(col);
                const batch = writeBatch(db);
                snap.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            } catch(err) {alert('Ошибка: '+err.message);}
            document.getElementById('confirmYes').disabled = false;
        };

        document.getElementById('menuToggle').onclick = () => sidebar.classList.toggle('active');
    </script>
</body>
</html>
