<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoMap ‚Äî –û—Ç—á—ë—Ç—ã –æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è—Ö</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        :root {
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
            --gray: #6c757d;
            --bg: #f7f9fc;
            --card-bg: #ffffff;
            --radius: 18px;
            --shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        body {margin:0; height:100vh; overflow:hidden; font-family:system-ui,sans-serif; background:var(--bg);}
        #map {position:fixed; inset:0; z-index:1;}

        .sidebar {
            position:fixed; top:0; right:0; height:100%; width:380px; max-width:95vw;
            background:white; padding:20px; box-shadow:-8px 0 30px rgba(0,0,0,0.15);
            overflow-y:auto; z-index:100; transition:transform .35s ease;
        }
        @media (max-width:768px) {.sidebar{transform:translateX(100%);}.sidebar.active{transform:translateX(0);}}

        .overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.65);
            display:none; align-items:center; justify-content:center; z-index:1002;
            padding:20px; box-sizing:border-box;
        }
        .card {
            background:var(--card-bg); padding:32px; border-radius:var(--radius);
            width:100%; max-width:540px; box-shadow:var(--shadow); position:relative;
        }
        .row {margin-bottom:20px;}
        .row label {display:block; margin-bottom:8px; font-weight:600; font-size:15px; color:#333;}
        .row input, .row textarea {
            width:100%; padding:14px; border:1px solid #ddd; border-radius:12px; font-size:16px;
        }
        .row input:disabled {background:#f8f9fa;}
        .thumb {width:100%; max-height:220px; object-fit:cover; border-radius:12px; margin-top:12px; border:1px solid #eee;}

        .loading {
            position:absolute; inset:0; background:rgba(255,255,255,0.95);
            display:none; align-items:center; justify-content:center; border-radius:var(--radius); z-index:10;
        }
        .spinner {
            width:44px; height:44px; border:5px solid #f0f0f0; border-top:5px solid var(--primary);
            border-radius:50%; animation:spin 1s linear infinite;
        }
        @keyframes spin {to{transform:rotate(360deg)}}

        button {
            padding:12px 20px; border:none; border-radius:12px; font-weight:600; cursor:pointer; transition:all .2s;
        }
        .btn-primary {background:var(--primary); color:white;}
        .btn-primary:hover {opacity:0.92;}
        .btn-ghost {background:transparent; color:var(--primary); border:2px solid #cfe2ff;}
        .btn-ghost:hover {background:#e7f0ff;}
        .btn-danger {background:var(--danger); color:white;}
    </style>
</head>
<body>
    <div id="map"></div>

    <button id="menuToggle" style="position:fixed;top:16px;right:16px;z-index:1001;background:rgba(0,123,255,0.9);color:white;border:none;width:56px;height:56px;border-radius:50%;font-size:24px;box-shadow:0 4px 15px rgba(0,0,0,0.25);display:none;"><i class="fas fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <h1 style="font-size:26px;display:flex;align-items:center;gap:10px;">üóëÔ∏è EcoMap</h1>
        <p style="color:#666;margin-bottom:20px;">–û—Ç—á—ë—Ç—ã –æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è—Ö –æ—Ç –∂–∏—Ç–µ–ª–µ–π</p>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
            <button id="addPointBtn" class="btn-primary">üìç –°–æ–æ–±—â–∏—Ç—å –æ —Ç–æ—á–∫–µ</button>
            <button id="exportBtn" class="btn-ghost" disabled>Export JSON</button>
            <button id="clearBtn" class="btn-ghost" disabled>Clear All</button>
        </div>

        <div id="confirmBox" style="display:none;background:#fff3cd;padding:16px;border-radius:12px;border:1px solid #ffeaa7;margin-bottom:16px;">
            <strong>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç—á—ë—Ç—ã?</strong><br><br>
            <button id="confirmYes" class="btn-danger">–î–∞</button>
            <button id="confirmNo" class="btn-ghost">–ù–µ—Ç</button>
        </div>

        <div id="list"></div>
    </div>

    <div class="overlay" id="overlay">
        <div class="card">
            <div class="loading" id="loading"><div class="spinner"></div></div>
            <h3 style="margin:0 0 24px;font-size:22px;">–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è</h3>
            <div id="error" style="color:var(--danger);margin-bottom:16px;font-weight:600;"></div>

            <div class="row"><label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label><input type="text" id="coords" disabled></div>
            <div class="row"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label><input id="title" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–∞–ª–∫–∞ —É —Ä–µ–∫–∏"></div>
            <div class="row"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="desc" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></textarea></div>
            <div class="row"><label>–§–æ—Ç–æ (–¥–æ 2 –ú–ë)</label><input id="photo" type="file" accept="image/*"><img id="preview" class="thumb" style="display:none;"></div>

            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                <button id="cancel" class="btn-ghost">–û—Ç–º–µ–Ω–∞</button>
                <button id="save" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á—ë—Ç</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

        const app = initializeApp({
            apiKey: "AIzaSyBchhpXlXNukYDgQHlRD0qPfQjvf8hsS8",
            authDomain: "ecomap-22dc4.firebaseapp.com",
            projectId: "ecomap-22dc4",
            storageBucket: "ecomap-22dc4.appspot.com",
            messagingSenderId: "88803528674",
            appId: "1:88803528674:web:d33c8ddacccf2286be33bb"
        });

        const db = getFirestore(app);
        const storage = getStorage(app);
        const col = collection(db, "reports");

        const map = L.map('map').setView([43.25, 76.95], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap'}).addTo(map);
        const markers = L.layerGroup().addTo(map);
        setTimeout(() => map.invalidateSize(), 200);

        const openIcon = L.divIcon({html:'<i class="fa fa-trash" style="color:#d32f2f;font-size:28px;"></i>', iconSize:[30,30], iconAnchor:[15,30]});
        const cleanIcon = L.divIcon({html:'<i class="fa fa-check-circle" style="color:#4caf50;font-size:28px;"></i>', iconSize:[30,30], iconAnchor:[15,30]});

        const sidebar = document.getElementById('sidebar');
        const list = document.getElementById('list');
        const overlay = document.getElementById('overlay');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        let adding = false;
        let reports = [];

        onSnapshot(query(col, orderBy('created','desc')), snap => {
            reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
            render();
        });

        function render() {
            markers.clearLayers(); list.innerHTML = reports.length ? '' : '<p style="text-align:center;color:#888;margin:40px 0;">–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤</p>';
            document.getElementById('exportBtn').disabled = document.getElementById('clearBtn').disabled = !reports.length;

            reports.forEach(r => {
                const date = r.created ? new Date(r.created.seconds*1000) : new Date();
                const div = document.createElement('div');
                div.style = 'background:white;padding:16px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);margin-bottom:16px;';
                div.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong style="font-size:17px;">${r.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
                        <span style="padding:4px 10px;border-radius:20px;font-size:12px;font-weight:bold;background:${r.cleaned?'#e8f5e9':'#ffebee'};color:${r.cleaned?'#28a745':'#dc3545'};">${r.cleaned?'–£–±—Ä–∞–Ω–æ':'–û—Ç–∫—Ä—ã—Ç–æ'}</span>
                    </div>
                    <div style="font-size:13px;color:#666;margin:8px 0;">${date.toLocaleString('ru').slice(0,-3)} ‚Ä¢ ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
                    ${r.description ? `<p style="margin:8px 0;">${r.description}</p>` : ''}
                    ${r.photo ? `<img src="${r.photo}" class="thumb">` : ''}
                    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="small" data-id="${r.id}" data-act="go">–ù–∞ –∫–∞—Ä—Ç—É</button>
                        <button class="small btn-ghost" data-id="${r.id}" data-act="toggle">${r.cleaned?'–û—Ç–º–µ–Ω–∏—Ç—å':'–£–±—Ä–∞–Ω–æ'}</button>
                        <button class="small btn-ghost" style="color:#dc3545;" data-id="${r.id}" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                list.appendChild(div);

                L.marker([r.lat, r.lng], {icon: r.cleaned?cleanIcon:openIcon}).addTo(markers)
                 .bindPopup(`<b>${r.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</b><br>${r.description||''}${r.photo?`<img src="${r.photo}" style="width:100%;margin-top:8px;border-radius:8px;">`:''}`, {maxWidth:320});
            });
        }

        document.getElementById('addPointBtn').onclick = () => {
            adding = true;
            map.getContainer().style.cursor = 'crosshair';
        };

        map.on('click', e => {
            if (!adding) return;
            adding = false;
            map.getContainer().style.cursor = '';

            document.getElementById('coords').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            document.getElementById('title').value = document.getElementById('desc').value = '';
            document.getElementById('photo').value = ''; document.getElementById('preview').style.display = 'none';
            errorDiv.textContent = '';
            overlay.style.display = 'flex';
            window.pos = e.latlng;
            window.photoData = null;
        });

        document.getElementById('cancel').onclick = () => overlay.style.display = 'none';
        overlay.onclick = e => {if(e.target===overlay) overlay.style.display='none';};

        document.getElementById('photo').onchange = e => {
            const f = e.target.files[0];
            if (!f) return;
            if (f.size > 2*1024*1024) { errorDiv.textContent = '–§–æ—Ç–æ –±–æ–ª—å—à–µ 2 –ú–ë'; return; }
            const r = new FileReader();
            r.onload = () => { document.getElementById('preview').src = r.result; document.getElementById('preview').style.display = 'block'; window.photoData = r.result; };
            r.readAsDataURL(f);
        };

        document.getElementById('save').onclick = async () => {
            const title = document.getElementById('title').value.trim();
            if (!title) return errorDiv.textContent = '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!';

            const saveBtn = document.getElementById('save');
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            loading.style.display = 'flex';
            errorDiv.textContent = '';

            try {
                let url = null;
                if (window.photoData) {
                    const sref = ref(storage, `photos/${Date.now()}.jpg`);
                    await uploadString(sref, window.photoData, 'data_url');
                    url = await getDownloadURL(sref);
                }
                await addDoc(col, {
                    title,
                    description: document.getElementById('desc').value.trim(),
                    lat: window.pos.lat,
                    lng: window.pos.lng,
                    photo: url,
                    cleaned: false,
                    created: serverTimestamp()
                });
                overlay.style.display = 'none';
            } catch (err) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: ' + (err.message || '–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á—ë—Ç';
                loading.style.display = 'none';
            }
        };

        list.onclick = async e => {
            const b = e.target.closest('button');
            if (!b) return;
            b.disabled = true;
            const id = b.dataset.id;
            try {
                if (b.dataset.act === 'go') map.setView([reports.find(r=>r.id===id).lat, reports.find(r=>r.id===id).lng], 17);
                if (b.dataset.act === 'toggle') await updateDoc(doc(db,'reports',id),{cleaned:!reports.find(r=>r.id===id).cleaned});
                if (b.dataset.act === 'del' && confirm('–£–¥–∞–ª–∏—Ç—å?')) await deleteDoc(doc(db,'reports',id));
            } catch(err) {alert(err.message);}
            b.disabled = false;
        };

        document.getElementById('exportBtn').onclick = () => {
            const data = reports.map(r=>({...r, created: r.created?.toDate?.().toISOString()||null}));
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)], {type:'application/json'}));
            a.download = `ecomap_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        document.getElementById('clearBtn').onclick = () => document.getElementById('confirmBox').style.display = 'block';
        document.getElementById('confirmNo').onclick = () => document.getElementById('confirmBox').style.display = 'none';
        document.getElementById('confirmYes').onclick = async () => {
            document.getElementById('confirmBox').style.display = 'none';
            document.getElementById('confirmYes').disabled = true;
            try {
                const snap = await getDocs(col);
                const batch = writeBatch(db);
                snap.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            } catch(err) {alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: '+err.message);}
            document.getElementById('confirmYes').disabled = false;
        };

        document.getElementById('menuToggle').onclick = () => sidebar.classList.toggle('active');
    </script>
</body>
</html>
