<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoMap ‚Äî –û—Ç—á—ë—Ç—ã –æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è—Ö</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
   
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-color: #f7f9fc;
            --text-color: #333;
            --shadow-light: 0 4px 12px rgba(0,0,0,0.1);
        }
        body {font-family: 'Inter', system-ui, Arial, sans-serif; margin:0; height:100vh; width:100vw; color:var(--text-color); overflow:hidden; position:relative;}
        #map {position:fixed; top:0; right:0; bottom:0; left:0; z-index:1; background:#ccc;}
        .sidebar {position:absolute; top:0; right:0; height:100%; width:380px; min-width:320px; max-width:400px; background:var(--bg-color); padding:16px; box-shadow:-4px 0 16px rgba(0,0,0,0.08); overflow-y:auto; display:flex; flex-direction:column; z-index:100; box-sizing:border-box; transition:transform .3s; transform:translateX(0);}
        h1 {font-size:24px; margin:0 0 12px; color:var(--primary-color);}
        .meta {font-size:13px; color:var(--secondary-color); margin-bottom:12px;}
        .report {border:1px solid #e3e8ef; padding:12px; margin-bottom:10px; border-radius:10px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.05);}
        button {padding:10px 14px; border-radius:8px; border:0; background:var(--primary-color); color:#fff; cursor:pointer; font-weight:600; transition:all .2s;}
        button:hover:not(:disabled) {opacity:0.9; box-shadow:0 4px 8px rgba(0,123,255,0.3);}
        button:disabled {background:#aaa; cursor:not-allowed;}
        .btn-ghost {background:transparent; color:var(--primary-color); border:1px solid #cfe3ff;}
        .small {font-size:13px; padding:8px 12px; font-weight:normal;}
        .status-open {color:var(--danger-color); font-weight:600;}
        .status-clean {color:var(--success-color); font-weight:600;}
        .thumb {width:100%; max-height:160px; object-fit:cover; border-radius:8px; margin-top:8px; border:1px solid #eee;}
        #menuToggle {position:absolute; top:15px; right:15px; z-index:1001; padding:10px 15px; border-radius:50%; background:rgba(0,123,255,0.8); color:white; box-shadow:0 4px 8px rgba(0,0,0,0.2); display:none;}
        .overlay {position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:1002; overflow-y:auto;}
        .card {
            background:white; padding:28px; border-radius:16px;
            width:520px; max-width:94%;
            box-shadow:var(--shadow-light);
            position:relative;
        }
        .row {margin-bottom:18px;}
        .row label {display:block; margin-bottom:8px; font-weight:600; color:#333;}
        .row input, .row textarea {
            width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:15px;
        }
        .row input:disabled {background:#f8f9fa;}
        .loading {
            position:absolute; inset:0; background:rgba(255,255,255,0.9); display:none;
            align-items:center; justify-content:center; border-radius:16px; z-index:10;
        }
        .spinner {border:4px solid #f3f3f3; border-top:4px solid var(--primary-color); border-radius:50%; width:36px; height:36px; animation:spin 1s linear infinite;}
        @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
        .map-adding-mode {cursor:crosshair !important;}
        #addModeMessage {position:absolute; top:10px; left:50%; transform:translateX(-50%); background:var(--primary-color); color:white; padding:8px 15px; border-radius:8px; box-shadow:var(--shadow-light); font-size:14px; z-index:999; display:none; white-space:nowrap;}
        #confirmationMessage {margin-top:10px; padding:10px; border-radius:8px; background:#ffcccc; border:1px solid var(--danger-color); color:#333; font-size:14px; display:none;}
        #confirmationMessage button {background:var(--danger-color); margin-left:8px; padding:5px 10px;}
        #confirmationMessage .btn-ghost {color:var(--danger-color); border-color:#ffcccc; background:#fff;}
        @media (max-width:768px) {
            .sidebar {transform:translateX(100%);}
            .sidebar.active {transform:translateX(0);}
            #menuToggle {display:block;}
            .card {padding:20px; width:96%;}
        }
        #fatalErrorOverlay {position:fixed; inset:0; background:rgba(255,0,0,0.9); color:white; z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; padding:20px; text-align:center;}
        .error-message {background:#f8d7da; color:#721c24; padding:10px; border-radius:8px; margin:10px 0;}
    </style>
</head>
<body>
    <div id="fatalErrorOverlay">
        <h2>‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–ô</h2>
        <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)</p>
        <p id="fatalErrorMessage" style="font-weight:bold;margin-top:20px;"></p>
    </div>
    <div id="map"></div>
    <div id="addModeMessage">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ <a href="#" id="cancelAddMode" style="color:#ffcc00;font-weight:bold;">–æ—Ç–º–µ–Ω–∏—Ç–µ</a></div>
   
    <button id="menuToggle"><i class="fas fa-bars"></i></button>
    <div class="sidebar" id="sidebar">
        <h1>üóëÔ∏è EcoMap ‚Äî –û—Ç—á—ë—Ç—ã –æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è—Ö</h1>
        <p class="meta">–ú–µ—Å—Ç–Ω—ã–µ –∂–∏—Ç–µ–ª–∏ —Å–æ–æ–±—â–∞—é—Ç –æ –º–µ—Å—Ç–∞—Ö, —Ç—Ä–µ–±—É—é—â–∏—Ö —É–±–æ—Ä–∫–∏.</p>
       
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
            <button id="addPointBtn" class="btn">üìç –°–æ–æ–±—â–∏—Ç—å –æ —Ç–æ—á–∫–µ</button>
            <button id="exportBtn" class="small btn-ghost" disabled>Export JSON</button>
            <button id="clearBtn" class="small btn-ghost" disabled>Clear All</button>
        </div>
       
        <div id="confirmationMessage">
            <p style="margin:0 0 10px;"><strong>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –æ—Ç—á–µ—Ç—ã?</strong></p>
            <button id="confirmYes">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
            <button id="confirmNo" class="btn-ghost">–ù–µ—Ç</button>
        </div>
        <div id="reportsList"></div>
        <div class="thematic-content">
            <h3>üå± –ù–∞—à–∞ –º–∏—Å—Å–∏—è</h3>
            <div style="width:100%;height:150px;background:#e9f3ff;background-image:url('https://picsum.photos/400/150?grayscale&blur=2&random=1');background-size:cover;background-position:center;border-radius:10px;margin-bottom:15px;box-shadow:0 4px 8px rgba(0,0,0,0.05);"></div>
            <p>EcoMap ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –±–æ—Ä—å–±—ã —Å –º—É—Å–æ—Ä–æ–º. –í–∞—à–∏ –æ—Ç—á—ë—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º –∏ –≤–ª–∞—Å—Ç—è–º.</p>
            <p class="meta" style="margin-top:10px;">Leaflet ‚Ä¢ Firebase ‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω</p>
        </div>
    </div>
       
    <div class="overlay" id="overlay">
        <div class="card">
            <div class="loading" id="loadingOverlay"><div class="spinner"></div></div>
            <h3>–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è</h3>
            <div id="modalErrorContainer"></div>
            <div class="row">
                <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
                <input type="text" id="coords" disabled />
            </div>
            <div class="row">
                <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input id="titleInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–∞–ª–∫–∞ —É –æ–∑–µ—Ä–∞" />
            </div>
            <div class="row">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="descInput" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã..."></textarea>
            </div>
            <div class="row">
                <label>–§–æ—Ç–æ (–¥–æ 2 –ú–ë, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input id="photoInput" type="file" accept="image/*" />
                <img id="photoPreview" class="thumb" style="display:none;" />
 solos           </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button id="cancelBtn" class="btn-ghost">–û—Ç–º–µ–Ω–∞</button>
                <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á—ë—Ç</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        function showFatalError(msg) {
            document.getElementById('fatalErrorMessage').textContent = msg;
            document.getElementById('fatalErrorOverlay').style.display = 'flex';
            console.error(msg);
        }

        const firebaseConfig = {
          apiKey: "AIzaSyBchhpXlXNukYDgQHlRD0qPfQjvf8hsS8",
          authDomain: "ecomap-22dc4.firebaseapp.com",
          projectId: "ecomap-22dc4",
          storageBucket: "ecomap-22dc4.firebasestorage.app",
          messagingSenderId: "88803528674",
          appId: "1:88803528674:web:d33c8ddacccf2286be33bb"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const reportsCollection = collection(db, "reports");

        let reports = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof L === 'undefined') return showFatalError('Leaflet –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');

            const map = L.map('map').setView([43.25, 76.95], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap'}).addTo(map);
            const markers = L.layerGroup().addTo(map);
            setTimeout(() => map.invalidateSize(), 200);

            const iconOpen = new L.DivIcon({className:'marker-icon-open', html:'<i class="fa fa-trash"></i>', iconSize:[30,30], iconAnchor:[15,30]});
            const iconCleaned = new L.DivIcon({className:'marker-icon-clean', html:'<i class="fa fa-check"></i>', iconSize:[30,30], iconAnchor:[15,30]});

            const sidebar = document.getElementById('sidebar');
            const list = document.getElementById('reportsList');
            const overlay = document.getElementById('overlay');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const addBtn = document.getElementById('addPointBtn');
            const exportBtn = document.getElementById('exportBtn');
            const clearBtn = document.getElementById('clearBtn');
            const confirmBox = document.getElementById('confirmationMessage');

            let adding = false;

            onSnapshot(query(reportsCollection, orderBy('created', 'desc')), snap => {
                reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });

            function render() {
                markers.clearLayers();
                list.innerHTML = reports.length === 0 ? '<p class="meta" style="text-align:center;margin:30px 0;">–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º–∏!</p>' : '';
                exportBtn.disabled = clearBtn.disabled = reports.length === 0;

                reports.forEach(r => {
                    const date = r.created ? new Date(r.created.seconds * 1000) : new Date();
                    const div = document.createElement('div');
                    div.className = 'report';
                    div.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>${escape(r.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</strong>
                            <span class="${r.cleaned ? 'status-clean' : 'status-open'}">${r.cleaned ? '–£–±—Ä–∞–Ω–æ' : '–û—Ç–∫—Ä—ã—Ç–æ'}</span>
                        </div>
                        <div class="meta">${date.toLocaleString('ru', {dateStyle:'short', timeStyle:'short'})} ‚Ä¢ ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
                        ${r.description ? `<div>${escape(r.description)}</div>` : ''}
                        ${r.photo ? `<img src="${r.photo}" class="thumb">` : ''}
                        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="small" data-id="${r.id}" data-act="go">–ü–µ—Ä–µ–π—Ç–∏</button>
                            <button class="small btn-ghost" data-id="${r.id}" data-act="toggle">${r.cleaned ? '–û—Ç–º–µ–Ω–∏—Ç—å' : '–£–±—Ä–∞–Ω–æ'}</button>
                            <button class="small btn-ghost" style="color:var(--danger-color)" data-id="${r.id}" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    list.appendChild(div);

                    const marker = L.marker([r.lat, r.lng], {icon: r.cleaned ? iconCleaned : iconOpen}).addTo(markers);
                    marker.bindPopup(`<b>${escape(r.title)}</b><br><small>${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</small><hr><p>${escape(r.description||'')}</p>${r.photo ? `<img src="${r.photo}" style="width:100%;margin-top:8px;border-radius:8px;">` : ''}`);
                });
            }

            function escape(s) { return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

            addBtn.onclick = () => {
                adding = true;
                document.getElementById('addModeMessage').style.display = 'block';
                map.getContainer().style.cursor = 'crosshair';
                if(innerWidth<=768) sidebar.classList.remove('active');
            };
            document.getElementById('cancelAddMode').onclick = e => { e.preventDefault(); adding = false; document.getElementById('addModeMessage').style.display = 'none'; map.getContainer().style.cursor = ''; };

            map.on('click', e => {
                if (!adding) return;
                adding = false;
                document.getElementById('addModeMessage').style.display = 'none';
                map.getContainer().style.cursor = '';

                document.getElementById('coords').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
                document.getElementById('titleInput').value = '';
                document.getElementById('descInput').value = '';
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('modalErrorContainer').innerHTML = '';
                overlay.style.display = 'flex';
                window.currentPos = e.latlng;
                window.currentPhoto = null;
            });

            document.getElementById('cancelBtn').onclick = () => overlay.style.display = 'none';
            overlay.onclick = e => { if(e.target === overlay) overlay.style.display = 'none'; };

            document.getElementById('photoInput').onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 2*1024*1024) { document.getElementById('modalErrorContainer').innerHTML = '<div class="error-message">–§–æ—Ç–æ –±–æ–ª—å—à–µ 2 –ú–ë!</div>'; return; }
                const reader = new FileReader();
                reader.onload = () => {
                    document.getElementById('photoPreview').src = reader.result;
                    document.getElementById('photoPreview').style.display = 'block';
                    window.currentPhoto = reader.result;
                };
                reader.readAsDataURL(file);
            };

            document.getElementById('saveBtn').onclick = async () => {
                const title = document.getElementById('titleInput').value.trim();
                if (!title) return document.getElementById('modalErrorContainer').innerHTML = '<div class="error-message">–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫!</div>';

                const saveBtn = document.getElementById('saveBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                loadingOverlay.style.display = 'flex';

                try {
                    let photoURL = null;
                    if (window.currentPhoto) {
                        const storageRef = ref(storage, `photos/${Date.now()}.jpg`);
                        await uploadString(storageRef, window.currentPhoto, 'data_url');
                        photoURL = await getDownloadURL(storageRef);
                    }

                    await addDoc(reportsCollection, {
                        title,
                        description: document.getElementById('descInput').value.trim(),
                        lat: window.currentPos.lat,
                        lng: window.currentPos.lng,
                        photo: photoURL,
                        cleaned: false,
                        created: serverTimestamp()
                    });
                    overlay.style.display = 'none';
                } catch (err) {
                    document.getElementById('modalErrorContainer').innerHTML = `<div class="error-message">–û—à–∏–±–∫–∞: ${err.message}</div>`;
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á—ë—Ç';
                    loadingOverlay.style.display = 'none';
                }
            };

            list.onclick = async e => {
                const btn = e.target.closest('button');
                if (!btn) return;
                btn.disabled = true;
                const id = btn.dataset.id;
                const act = btn.dataset.act;

                try {
                    if (act === 'go') map.setView([reports.find(r=>r.id===id).lat, reports.find(r=>r.id===id).lng], 17);
                    if (act === 'toggle') await updateDoc(doc(db, "reports", id), {cleaned: !reports.find(r=>r.id===id).cleaned});
                    if (act === 'del' && confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç—á—ë—Ç?')) await deleteDoc(doc(db, "reports", id));
                } catch (err) { alert('–û—à–∏–±–∫–∞: ' + err.message); }
                btn.disabled = false;
            };

            exportBtn.onclick = () => {
                const data = reports.map(r => ({...r, created: r.created ? new Date(r.created.seconds*1000).toISOString() : null}));
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `ecomap_${new Date().toISOString().slice(0,10)}.json`;
                a.click(); URL.revokeObjectURL(url);
            };

            clearBtn.onclick = () => confirmBox.style.display = 'block';
            document.getElementById('confirmNo').onclick = () => confirmBox.style.display = 'none';
            document.getElementById('confirmYes').onclick = async () => {
                confirmBox.style.display = 'none';
                document.getElementById('confirmYes').disabled = true;
                try {
                    const snap = await getDocs(reportsCollection);
                    const batch = writeBatch(db);
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                } catch (err) { alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + err.message); }
                document.getElementById('confirmYes').disabled = false;
            };

            document.getElementById('menuToggle').onclick = () => sidebar.classList.toggle('active');
        });
    </script>
</body>
</html>
